{% extends "_base.html" %}
{% block title %}Sensor Data {% endblock title %}
{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Data</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid black;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .pagination {
            margin: 20px 0;
        }
        .pagination span, .pagination a {
            margin: 0 5px;
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid #ddd;
            color: black;
        }
        .pagination .current {
            background-color: #f2f2f2;
            color: #000;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Sensor Data</h1>

    <!-- Sensor selection form -->
    <form id="sensor-form">
        <label for="sensor">Select Sensor:</label>
        <select name="sensor" id="sensor">
            <option value="">All Sensors</option>
            {% for sensor in sensors %}
                <option value="{{ sensor.id }}">{{ sensor.sensor_id }}</option>
            {% endfor %}
        </select>
    </form>

    <!-- Data Table -->
    <div id="data-table">
        <table>
            <thead>
                <tr>
                    <th>Sensor Name</th>
                    <th>Sensor ID</th>
                    <th>Temperature (Â°C)</th>
                    <th>Humidity (%)</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <!-- Data will be dynamically inserted here -->
            </tbody>
        </table>
    </div>

    <!-- Pagination Controls -->
    <div class="pagination" id="pagination">
        <!-- Pagination links will be dynamically inserted here -->
    </div>

    <script>
        $(document).ready(function() {
            loadData();

            $('#sensor').change(function() {
                loadData();
            });

            function loadData(page = 1) {
                var sensorId = $('#sensor').val();
                $.ajax({
                    url: '{% url "sensor-data-list" %}',
                    method: 'GET',
                    data: {
                        sensor: sensorId,
                        page: page
                    },
                    success: function(response) {
                        updateTable(response.data);
                        updatePagination(response.pagination);
                    }
                });
            }

            function updateTable(data) {
                $('#table-body').empty();
                if (data.length > 0) {
                    data.forEach(function(item) {
                        // Convert UTC timestamp to Nepal time
                        const timestampNepal = new Date(item.timestamp).toLocaleString('en-US', {
                            timeZone: 'Asia/Kathmandu',
                            hour12: false, // Set to true if you prefer 12-hour format
                        });
                        $('#table-body').append(`
                            <tr>
                                <td>${item.sensor_name}</td>
                                <td>${item.sensor_id}</td>
                                <td>${item.temperature}</td>
                                <td>${item.humidity}</td>
                                <td>${timestampNepal}</td>
                            </tr>
                        `);
                    });
                } else {
                    $('#table-body').append(`
                        <tr>
                            <td colspan="5">No data available for the selected sensor.</td>
                        </tr>
                    `);
                }
            }

            function updatePagination(pagination) {
                $('#pagination').empty();
                if (pagination.has_previous) {
                    $('#pagination').append(`<a href="#" data-page="1">First</a>`);
                    $('#pagination').append(`<a href="#" data-page="${pagination.previous_page_number}">Previous</a>`);
                }
                $('#pagination').append(`<span class="current">Page ${pagination.number} of ${pagination.num_pages}</span>`);
                if (pagination.has_next) {
                    $('#pagination').append(`<a href="#" data-page="${pagination.next_page_number}">Next</a>`);
                    $('#pagination').append(`<a href="#" data-page="${pagination.num_pages}">Last</a>`);
                }
                $('#pagination a').click(function(e) {
                    e.preventDefault();
                    var page = $(this).data('page');
                    loadData(page);
                });
            }
        });
    </script>

</body>
</html>

{% endblock content %}
