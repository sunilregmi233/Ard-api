{% extends "_base.html" %}
{% block title %}Home{% endblock title %}
{% block content %}

    <style>
         .map-container {
            padding: 2rem;
            border-radius: 10px;
        }
        
        #map {
            width: 100%;
            height: 100vh;
            border-radius: 10px;
        }
    </style>


<!-- Resource Map Section -->
<div class="">
    <div class="map-container">
        <h2 class="text-center my-4">Resource Map</h2>
        <!-- Dropdown for selecting region -->


        <!-- Map Placeholder -->
        <div id="map" ></div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
<script>
    // Adjust the map container to fit the screen
    function resizeMapContainer() {
        const windowHeight = window.innerHeight;
        const headerHeight = document.querySelector('h2').offsetHeight;
        const mapContainer = document.querySelector('#map');
        mapContainer.style.height = (windowHeight - headerHeight - 50) + 'px';
    }

    // Initialize the map centered around Janakpur
    var map = L.map('map').setView([26.7183, 85.9165], 13); // Centered on Janakpur

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
    }).addTo(map);

    // Function to fetch and display markers dynamically
    function loadSensorData() {
        $.ajax({
            url: '/api/latest-sensors-data/',  // Replace with your backend endpoint
            method: 'GET',
            success: function(response) {
                console.log(response);
                // Clear existing markers
                map.eachLayer(function(layer) {
                    if (layer instanceof L.Marker || layer instanceof L.LayerGroup) {
                        map.removeLayer(layer);
                    }
                });

                // Add new markers from response data
                response.forEach(function(sensor) {
                    if (sensor.coordinates && sensor.coordinates.latitude && sensor.coordinates.longitude) {
                        // Determine the status (green or red)
                        const statusColor = sensor.is_active ? 'red' : 'green';

                        // Create a custom icon
                        var customIcon = L.divIcon({
                            className: 'custom-marker', // Add a class for custom styling
                            html: `
                                <div style="position: relative; text-align: center; color: white;">
                                    <div style="
                                        width: 40px;
                                        height: 40px;
                                        background-color: #2f3e50;
                                        border-radius: 50%;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        font-weight: bold;
                                        font-size: 12px;
                                    ">
                                        ${sensor.sensor_id}
                                    </div>
                                    <div style="
                                        width: 10px;
                                        height: 10px;
                                        background-color: ${statusColor};
                                        border-radius: 50%;
                                        position: absolute;
                                        bottom: -5px;
                                        right: 15px;
                                    "></div>
                                </div>`,
                            iconSize: [40, 40],
                            iconAnchor: [20, 20]
                        });

                        // Add marker with the custom icon
                        L.marker([sensor.coordinates.latitude, sensor.coordinates.longitude], { icon: customIcon })
                            .bindPopup(
                                `<b>Sensor ID: ${sensor.sensor_id}</b><br>
                                 Temperature: ${sensor.temperature}°C<br>
                                 Humidity: ${sensor.humidity}%<br>
                                 Timestamp: ${sensor.timestamp}`
                            )
                            .addTo(map);
                    }
                });
            },
            error: function(error) {
                console.error("Error fetching sensor data:", error);
            }
        });
    }

    // Load data on page load
    $(document).ready(function() {
        resizeMapContainer();
        loadSensorData();

        // Refresh data every 60 seconds
        setInterval(loadSensorData, 60000);

        // Adjust map container size on window resize
        window.addEventListener('resize', resizeMapContainer);
    });
</script>


{% endblock content %}
